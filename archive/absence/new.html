<section class="m-3">
    <div class="hero">
        <div class="hero-body">
            <p class="title">欠席登録</p>
        </div>
    </div>
    <div class="m-6">
        <!-- フォームの部品 -->
        <div class="my-4">
            <label for="date">活動日</label>
            <input type="date" id="date" name="date" class="input" />
        </div>
        <input type="submit" value="照会" class="button is-outline is-info" id="btn_inquiry" />
        <br /><br />
        <strong id="result" class="has-text-danger"></strong>
        <br />
        <div class="my-4">
            <label>欠席する活動</label><br />
            <div class="select">
                <select id="activity"></select>
            </div>
        </div>
        <div class="my-4">
            <label for="type">種別</label>
            <input type="text" id="type" name="type" class="input" placeholder="欠席、早退、遅刻など" />
        </div>
        <div class="my-4">
            <label for="message">特記事項</label>
            <input type="text" id="message" name="message" class="input" placeholder="特記事項を入力" />
        </div>
        <input type="submit" value="登録する" class="button is-outline is-info" id="btn" disabled />
    </div>
</section>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
    var btn_inquiry = document.getElementById('btn_inquiry');
    btn_inquiry.addEventListener('click', function () {
        btn_inquiry.value = '照会中...';
        $(function () {
            google.script.run.withSuccessHandler(showThings_inquiry).getData('absence_inquery', document.getElementById('date').value);
        });
    });
    function showThings_inquiry(things) {
        if (things[0] == 'bad') {
            document.getElementById('result').textContent = '入力された日付に該当する活動がありません';
            btn_inquiry.value = '照会';
            document.getElementById('activity').textContent = '';
            document.getElementById('btn').disabled = true;
        } else {
            document.getElementById('result').textContent = '';
            document.getElementById('activity').textContent = '';
            for (i = 1; i < things[1].length; i++) {
                var optionele = document.createElement('option');
                title = String(things[1][i][4]) + ' ' + String(things[1][i][5]);
                optionele.appendChild(document.createTextNode(title));
                optionele.setAttribute('value', title);
                document.getElementById('activity').appendChild(optionele);
            }
            btn_inquiry.value = '照会';
            document.getElementById('btn').disabled = false;
        }
    }
</script>
<script>
    var btn = document.getElementById('btn');
    btn.addEventListener('click', function () {
        btn.value = '送信中...';
        $(function () {
            google.script.run
                .withSuccessHandler(absenceShowThings)
                .sendData(
                    'absence_new',
                    document.getElementById('date').value,
                    document.getElementById('activity').value,
                    document.getElementById('type').value,
                    document.getElementById('message').value
                );
        });
    });
    function absenceShowThings(things) {
        message = '成功しました\n名前：' + things[0] + '\n活動：' + things[1] + ' ' + things[2];
        window.alert(message);
        btn.value = '登録する';
        document.getElementById('date').value = '';
        document.getElementById('activity').value = '';
        document.getElementById('type').value = '';
        document.getElementById('select').value = '';
        document.getElementById('message').value = '';
    }
</script>
